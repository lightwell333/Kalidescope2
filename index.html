<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Perfect Kaleidoscope</title>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  canvas{display:block;width:100vw;height:100vh;touch-action:none;cursor:grab}
  #controls{position:fixed;top:10px;left:50%;transform:translateX(-50%);
    background:rgba(20,20,25,.75);padding:8px 12px;border-radius:12px;
    font-family:sans-serif;color:#fff;z-index:50}
  #controls button{margin:0 4px;padding:6px 10px;border-radius:8px;
    border:1px solid #444;background:#111;color:#fff}
</style>
</head>
<body>
<canvas id="gl"></canvas>

<div id="controls">
  <input type="file" id="img" accept="image/*,video/*,audio/*" />
  <button id="rec">⏺ Start Rec</button>
  <a id="dl" style="display:none" download>Download</a>
</div>

<script>
const canvas=document.getElementById("gl");
const gl=canvas.getContext("webgl",{preserveDrawingBuffer:true});
function fit(){canvas.width=innerWidth;canvas.height=innerHeight;gl.viewport(0,0,canvas.width,canvas.height);}
addEventListener("resize",fit);fit();

// shader
const vsrc=`attribute vec2 a;varying vec2 v;void main(){v=a*0.5+0.5;gl_Position=vec4(a,0,1);}`;
const fsrc=`precision highp float;varying vec2 v;uniform sampler2D tex;uniform int hasTex;
uniform vec2 res;uniform float t;uniform float rot;uniform float zoom;uniform int K;
vec2 kale(vec2 p){float asp=res.x/res.y;p.x*=asp;float ang=atan(p.y,p.x),rad=length(p);
float w=6.283185/float(K);ang=mod(ang,w);ang=abs(ang-0.5*w)-0.5*w;ang+=rot;vec2 q=vec2(cos(ang),sin(ang))*rad;q.x/=asp;q*=zoom;return q*0.5+0.5;}
vec3 rainbow(vec2 uv){return 0.5+0.5*cos(vec3(0,2.1,4.2)+uv.xyx*6.0+t*0.3);}
void main(){vec2 uv=kale(v*2.-1.);vec3 c=hasTex==1?texture2D(tex,uv).rgb:rainbow(uv);gl_FragColor=vec4(c,1);}
`;
function compile(type,src){const s=gl.createShader(type);gl.shaderSource(s,src);gl.compileShader(s);
if(!gl.getShaderParameter(s,gl.COMPILE_STATUS))throw gl.getShaderInfoLog(s);return s;}
const prog=gl.createProgram();
gl.attachShader(prog,compile(gl.VERTEX_SHADER,vsrc));
gl.attachShader(prog,compile(gl.FRAGMENT_SHADER,fsrc));
gl.linkProgram(prog);gl.useProgram(prog);
const buf=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,buf);
gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),gl.STATIC_DRAW);
const a=gl.getAttribLocation(prog,"a");gl.enableVertexAttribArray(a);gl.vertexAttribPointer(a,2,gl.FLOAT,0,0,0);
const U=n=>gl.getUniformLocation(prog,n);
const uRes=U("res"),uT=U("t"),uTex=U("tex"),uHas=U("hasTex"),uRot=U("rot"),uZoom=U("zoom"),uK=U("K");
gl.uniform1i(uTex,0);

let rot=0,zoom=1,K=12,tex=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,tex);
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);
gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array([0,0,0,255]));
let hasTex=0,video=null;
document.getElementById("img").onchange=e=>{
 const f=e.target.files[0];if(!f)return;
 if(f.type.startsWith("image/")){video=null;const img=new Image();img.onload=()=>{gl.bindTexture(gl.TEXTURE_2D,tex);
  gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,img);hasTex=1;};img.src=URL.createObjectURL(f);}
 else if(f.type.startsWith("video/")){video=document.createElement("video");video.src=URL.createObjectURL(f);video.loop=true;video.muted=true;video.play();hasTex=1;}
};

let last=performance.now();
function loop(){requestAnimationFrame(loop);const now=performance.now(),dt=(now-last)/1000;last=now;rot+=dt*0.4;
if(video&&video.readyState>=2){gl.bindTexture(gl.TEXTURE_2D,tex);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,video);}
gl.uniform2f(uRes,canvas.width,canvas.height);gl.uniform1f(uT,now/1000);gl.uniform1i(uHas,hasTex);
gl.uniform1f(uRot,rot);gl.uniform1f(uZoom,zoom);gl.uniform1i(uK,K);
gl.drawArrays(gl.TRIANGLE_STRIP,0,4);} loop();

// touch gestures
let pointers=new Map(),lastDist=0;
canvas.addEventListener("pointerdown",e=>{pointers.set(e.pointerId,e);});
canvas.addEventListener("pointermove",e=>{if(!pointers.has(e.pointerId))return;
pointers.set(e.pointerId,e);if(pointers.size==1){rot+=e.movementX*0.01;}
else if(pointers.size==2){const [a,b]=[...pointers.values()];
const d=Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);
if(!lastDist)lastDist=d;zoom*=1+(d-lastDist)*0.003;lastDist=d;}});
canvas.addEventListener("pointerup",e=>{pointers.delete(e.pointerId);lastDist=0;});

// recorder
const recBtn=document.getElementById("rec"),dl=document.getElementById("dl");let mr=null,chunks=[];
recBtn.onclick=()=>{if(mr&&mr.state==="recording"){mr.stop();return;}
try{const stream=canvas.captureStream(60);mr=new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp9'});
chunks=[];mr.ondataavailable=e=>{if(e.data.size)chunks.push(e.data)};
mr.onstop=()=>{const blob=new Blob(chunks,{type:'video/webm'});const url=URL.createObjectURL(blob);
dl.href=url;dl.style.display="inline";dl.textContent="Download";dl.download=`kaleido_${Date.now()}.webm`;recBtn.textContent="⏺ Start Rec";};
mr.start();recBtn.textContent="⏹ Stop";dl.style.display="none";}catch(err){alert("Recording not supported: "+err.message);}};
</script>
</body>
</html>
