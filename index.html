<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Psy Kaleidoscope ‚Äî Full AV Instrument</title>
<style>
  :root{--glass:rgba(12,14,18,.78);--line:#262c38;--fg:#eaf0ff;--muted:#a6b0c9}
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  canvas{display:block;width:100vw;height:100vh;touch-action:none;cursor:grab}
  /* Dock */
  #dock{position:fixed;left:50%;top:10px;transform:translateX(-50%);z-index:40;display:flex;gap:8px;align-items:center}
  #dock button{background:#0b0e14;border:1px solid var(--line);color:var(--fg);border-radius:12px;padding:8px 12px}
  #fpsBox{background:#0b0e14;border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:#9aa4c4}
  /* Panel */
  #panel{position:fixed;left:50%;top:56px;transform:translateX(-50%);z-index:50;max-width:min(96vw,1000px);background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--line);border-radius:16px;padding:12px 14px}
  #panel.hidden{display:none}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  .card{border:1px solid var(--line);border-radius:14px;padding:10px}
  .card h3{margin:0 0 6px 0;color:var(--muted);font:600 14px system-ui}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  label{font:12px system-ui;color:var(--muted)}
  input[type="range"]{width:170px}
  input[type="file"],select,button{background:#0b0e14;border:1px solid var(--line);color:var(--fg);border-radius:10px;padding:6px 10px}
  /* Dials */
  .dials{display:flex;gap:16px;flex-wrap:wrap}
  .dial{width:84px;height:84px;border-radius:50%;border:1px solid var(--line);position:relative;background:#0b0e14}
  .dial .cap{position:absolute;inset:10px;border-radius:50%;background:radial-gradient(120% 120% at 30% 30%, #1a2236, #080a10);box-shadow:inset 0 0 0 1px #1c2436}
  .dial .mark{position:absolute;left:50%;top:10px;width:2px;height:14px;background:#8aa2ff;transform-origin:50% 32px;border-radius:2px}
  .dial b{position:absolute;bottom:-18px;left:0;right:0;text-align:center;color:var(--muted);font:500 12px system-ui}
  /* Tips */
  #tips{position:fixed;left:10px;bottom:10px;z-index:30;color:#9aa4c4;font:12px system-ui;background:rgba(0,0,0,.45);padding:7px 10px;border-radius:10px;border:1px solid var(--line)}
  .ok{color:#9cff9c} .bad{color:#ff9c9c}
</style>
</head>
<body>
<canvas id="gl"></canvas>

<!-- Dock -->
<div id="dock">
  <button id="toggle" title="Show/Hide Controls (H)">üéõÔ∏è Controls</button>
  <button id="screenshot" title="Save PNG">üì∑ Screenshot</button>
  <button id="rec">‚è∫ Start</button>
  <a id="download" download style="display:none">Download</a>
  <div id="fpsBox">FPS <span id="fps">‚Äî</span></div>
</div>

<!-- Panel -->
<div id="panel">
  <div class="grid">

    <div class="card">
      <h3>Visual</h3>
      <div class="row"><label>Upload Visual</label><input id="visFile" type="file" accept="image/*,video/*"></div>
      <div class="row"><label>Wedges</label><input id="wedges" type="range" min="3" max="48" step="1" value="12"><span id="wedgesV">12</span></div>
      <div class="row"><label>Mirror</label>
        <select id="mirror"><option value="1" selected>On</option><option value="0">Off</option></select>
      </div>
      <div class="dials">
        <div class="dial" id="dialSpeed" data-min="-4" data-max="4" data-value="0"><div class="cap"></div><div class="mark"></div><b>Speed</b></div>
        <div class="dial" id="dialZoom"  data-min="0.2" data-max="4" data-value="1"><div class="cap"></div><div class="mark"></div><b>Zoom</b></div>
        <div class="dial" id="dialTwist" data-min="-2" data-max="2" data-value="0"><div class="cap"></div><div class="mark"></div><b>Twist</b></div>
      </div>
    </div>

    <div class="card">
      <h3>Audio</h3>
      <div class="row"><label>Upload Audio</label><input id="audFile" type="file" accept="audio/*"></div>
      <div class="row">
        <button id="play">‚ñ∂Ô∏è Play</button>
        <button id="mic">üé§ Mic Off</button>
        <button id="tone">üîî Test Tone</button><button id="donate">üíö Donate</button>

        <label>Vol</label><input id="vol" type="range" min="0" max="1" step="0.01" value="0.85">
      </div>
      <div class="row"><label>Filter</label>
        <select id="fType"><option>lowpass</option><option selected>bandpass</option><option>highpass</option></select>
        <label>Drive</label><input id="drive" type="range" min="0" max="1" step="0.01" value="0.25">
      </div>
      <div class="dials">
        <div class="dial" id="dialScratch" data-min="-2" data-max="2" data-value="0"><div class="cap"></div><div class="mark"></div><b>Scratch</b></div>
        <div class="dial" id="dialDist" data-min="0" data-max="1" data-value="0.2"><div class="cap"></div><div class="mark"></div><b>Distort</b></div>
      </div>
      <div class="row">
        <label>Touch‚ÜíAudio Link</label>
        <select id="touchAudio"><option value="1" selected>On</option><option value="0">Off</option></select>
        <span id="aStat" class="bad">No audio</span>
      </div>
    </div>

    <div class="card">
      <h3>Recording</h3>
      <div class="row">Records canvas + processed audio (best in desktop Chrome). iOS Safari may record video-only.</div>
    </div>

  </div>
</div>

<div id="tips">Touch: 1-finger drag = spin (also scratches audio). Pinch = zoom (also opens filter). Double-tap canvas toggles panel. Press <b>H</b> to hide/show.</div>

<script>
(() => {
  /* ========= WebGL Kaleidoscope ========= */
  const canvas = document.getElementById('gl');
  const gl = canvas.getContext('webgl',{preserveDrawingBuffer:true,antialias:true});
  if(!gl){ alert('WebGL not available'); return; }
  function fit(){ const dpr=Math.min(2,devicePixelRatio||1); canvas.width=Math.floor(innerWidth*dpr); canvas.height=Math.floor(innerHeight*dpr); gl.viewport(0,0,canvas.width,canvas.height);} addEventListener('resize',fit,{passive:true}); fit();

  const vsrc=`attribute vec2 a; varying vec2 v; void main(){ v=a*0.5+0.5; gl_Position=vec4(a,0.0,1.0);} `;
  const fsrc=`precision highp float; varying vec2 v; uniform vec2 R; uniform float T; uniform sampler2D tex; uniform int HAS; uniform int K; uniform float ROT; uniform float ZOOM; uniform float TW; uniform int MIR;
    vec2 kale(vec2 p){ float asp=R.x/R.y; p.x*=asp; float ang=atan(p.y,p.x); float rad=length(p); float w=6.28318530718/float(K);
      ang=mod(ang,w); if(MIR==1){ ang=abs(ang-0.5*w)-0.5*w; } ang += ROT + rad*TW;
      vec2 q=vec2(cos(ang),sin(ang))*rad; q.x/=asp; q*=ZOOM; return q*0.5+0.5; }
    vec3 rainbow(vec2 uv){ return 0.5+0.5*cos(vec3(0.0,2.094,4.188)+T*0.2+vec3(uv,0.0)*6.0); }
    void main(){ vec2 uv=kale(v*2.0-1.0); vec3 c = HAS==1 ? texture2D(tex,uv).rgb : rainbow(uv); gl_FragColor=vec4(c,1.0);} `;
  function sh(t,s){ const o=gl.createShader(t); gl.shaderSource(o,s); gl.compileShader(o); if(!gl.getShaderParameter(o,gl.COMPILE_STATUS)) throw new Error(gl.getShaderInfoLog(o)); return o; }
  const P=gl.createProgram(); gl.attachShader(P,sh(gl.VERTEX_SHADER,vsrc)); gl.attachShader(P,sh(gl.FRAGMENT_SHADER,fsrc)); gl.linkProgram(P); if(!gl.getProgramParameter(P,gl.LINK_STATUS)) throw new Error(gl.getProgramInfoLog(P)); gl.useProgram(P);
  const B=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,B); gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),gl.STATIC_DRAW);
  const A=gl.getAttribLocation(P,'a'); gl.enableVertexAttribArray(A); gl.vertexAttribPointer(A,2,gl.FLOAT,false,0,0);
  const U=n=>gl.getUniformLocation(P,n); const uR=U('R'),uT=U('T'),uTex=U('tex'),uHAS=U('HAS'),uK=U('K'),uROT=U('ROT'),uZOOM=U('ZOOM'),uTW=U('TW'),uMIR=U('MIR'); gl.uniform1i(uTex,0);

  // Texture
  const TEX=gl.createTexture(); gl.activeTexture(gl.TEXTURE0); gl.bindTexture(gl.TEXTURE_2D,TEX);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR); gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE); gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);
  gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true);
  gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array([24,24,24,255]));
  let HAS=false, video=null;
  function uploadImage(img){ gl.bindTexture(gl.TEXTURE_2D,TEX); gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true); gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,img); HAS=true; }

  /* ========= UI ========= */
  const panel=document.getElementById('panel'), toggle=document.getElementById('toggle');
  const wedges=document.getElementById('wedges'), wedgesV=document.getElementById('wedgesV');
  const mirror=document.getElementById('mirror'), touchAudio=document.getElementById('touchAudio');
  const screenshot=document.getElementById('screenshot');
  toggle.onclick=()=>panel.classList.toggle('hidden'); addEventListener('keydown',e=>{ if(e.key.toLowerCase()==='h') panel.classList.toggle('hidden'); });

  // Visual upload
  document.getElementById('visFile').addEventListener('change', e=>{
    const f=e.target.files?.[0]; if(!f) return;
    if(f.type.startsWith('image/')){ video=null; const img=new Image(); img.onload=()=>uploadImage(img); img.src=URL.createObjectURL(f); }
    else if(f.type.startsWith('video/')){ video=document.createElement('video'); video.src=URL.createObjectURL(f); video.loop=true; video.muted=true; video.playsInline=true; video.onloadeddata=()=>video.play(); HAS=true; }
  });

  /* ========= Dials ========= */
  function dial(el){ const mark=el.querySelector('.mark'); let min=+el.dataset.min,max=+el.dataset.max,val=+el.dataset.value;
    function set(){ const t=(val-min)/(max-min); const ang=-140+t*280; mark.style.transform=`translateX(-50%) rotate(${ang}deg)`; }
    set(); let dragging=false,lastA=0;
    function ang(e){ const r=el.getBoundingClientRect(); const cx=r.left+r.width/2, cy=r.top+r.height/2; const x=e.clientX||(e.touches&&e.touches[0].clientX), y=e.clientY||(e.touches&&e.touches[0].clientY); return Math.atan2(y-cy,x-cx)*180/Math.PI; }
    el.addEventListener('pointerdown',e=>{dragging=true;lastA=ang(e);el.setPointerCapture?.(e.pointerId);e.preventDefault();});
    addEventListener('pointermove',e=>{ if(!dragging) return; const a=ang(e); let d=a-lastA; if(d>180)d-=360; if(d<-180)d+=360; val=Math.min(max,Math.max(min,val+d/280*(max-min))); lastA=a; set(); el.dispatchEvent(new CustomEvent('input',{detail:val})); });
    addEventListener('pointerup',()=>dragging=false); addEventListener('pointercancel',()=>dragging=false);
    return {get:()=>val,set:v=>{val=Math.min(max,Math.max(min,v)); set(); el.dispatchEvent(new CustomEvent('input',{detail:val}));}};
  }
  const wSpeed=dial(document.getElementById('dialSpeed'));
  const wZoom =dial(document.getElementById('dialZoom'));
  const wTw   =dial(document.getElementById('dialTwist'));
  const wScratch=dial(document.getElementById('dialScratch'));
  const wDist   =dial(document.getElementById('dialDist'));

  /* ========= Audio Graph ========= */
  const AudioCtx=window.AudioContext||window.webkitAudioContext;
  const actx=new AudioCtx();
  const gain=actx.createGain(); gain.gain.value=0.85;
  const filter=actx.createBiquadFilter(); filter.type='bandpass'; filter.frequency.value=900; filter.Q.value=1.0;
  const shaper=actx.createWaveShaper(); function mkCurve(d){const n=256,c=new Float32Array(n);for(let i=0;i<n;i++){const x=i/(n-1)*2-1; c[i]=Math.tanh(x*(1+18*d));}return c;} shaper.curve=mkCurve(0.25);
  const merger=actx.createMediaStreamDestination(); // for recording
  filter.connect(shaper); shaper.connect(gain); gain.connect(actx.destination); gain.connect(merger);
  const aStat=document.getElementById('aStat');

  const audio=new Audio(); audio.loop=true; let mediaSrc=null;
  function connectAudioEl(){ if(mediaSrc){try{mediaSrc.disconnect();}catch{}} mediaSrc=actx.createMediaElementSource(audio); mediaSrc.connect(filter); }

  document.getElementById('audFile').addEventListener('change', e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const url=URL.createObjectURL(f); audio.src=url; connectAudioEl(); actx.resume(); audio.play(); document.getElementById('play').textContent='‚è∏Ô∏è Pause'; aStat.textContent='Audio loaded'; aStat.className='ok';
  });

  let micStream=null, usingMic=false;
  const micBtn=document.getElementById('mic');
  micBtn.onclick=async()=>{ if(usingMic){ if(micStream){micStream.getTracks().forEach(t=>t.stop());} usingMic=false; micBtn.textContent='üé§ Mic Off'; aStat.textContent=audio.src?'Audio loaded':'No audio'; aStat.className=audio.src?'ok':'bad'; return; }
    try{ micStream=await navigator.mediaDevices.getUserMedia({audio:true}); const mic=actx.createMediaStreamSource(micStream); mic.connect(filter); usingMic=true; micBtn.textContent='üé§ Mic On'; aStat.textContent='Mic live'; aStat.className='ok'; actx.resume(); }catch(err){ alert('Mic error: '+err.message); } };

  document.getElementById('play').onclick=e=>{ actx.resume(); if(audio.src){ if(audio.paused){audio.play(); e.target.textContent='‚è∏Ô∏è Pause'; aStat.textContent='Playing'; aStat.className='ok';} else {audio.pause(); e.target.textContent='‚ñ∂Ô∏è Play'; aStat.textContent='Paused'; aStat.className='ok';} } else { aStat.textContent='Load audio or use Mic/Test Tone'; aStat.className='bad'; } };
  document.getElementById('vol').oninput=e=>{ gain.gain.value=+e.target.value; };
  document.getElementById('fType').onchange=e=>{ filter.type=e.target.value; };
  document.getElementById('drive').oninput=e=>{ shaper.curve=mkCurve(+e.target.value); };

  // Test tone
  document.getElementById('tone').onclick=()=>{ actx.resume(); const osc=actx.createOscillator(), env=actx.createGain(); osc.type='sawtooth'; osc.frequency.value=220; env.gain.value=0; osc.connect(env); env.connect(filter); const t=actx.currentTime; env.gain.setValueAtTime(0,t); env.gain.linearRampToValueAtTime(0.9,t+0.01); env.gain.exponentialRampToValueAtTime(0.0001,t+0.6); osc.start(t); osc.stop(t+0.65); aStat.textContent='Test tone played'; aStat.className='ok'; };

  // Wheels ‚Üí visuals + audio
  let spinWheel=0, zoomBase=1, twist=0, scratch=0;
  document.getElementById('dialSpeed').addEventListener('input',e=>{spinWheel=e.detail;});
  document.getElementById('dialZoom').addEventListener('input',e=>{zoomBase=e.detail;});
  document.getElementById('dialTwist').addEventListener('input',e=>{twist=e.detail;});
  document.getElementById('dialScratch').addEventListener('input',e=>{scratch=e.detail;});
  document.getElementById('dialDist').addEventListener('input',e=>{const d=e.detail; shaper.curve=mkCurve(d); filter.Q.value=0.8+d*2.2; gain.gain.value=1+d*0.5; });

  /* ========= Screenshot ========= */
  document.getElementById('screenshot').onclick=()=>{ const url=canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download=`kaleidoscope_${Date.now()}.png`; a.click(); };

  /* ========= Recorder ========= */
  const recBtn=document.getElementById('rec'), dl=document.getElementById('download'); let mr=null, chunks=[];
  recBtn.onclick=()=>{ if(mr && mr.state==='recording'){ mr.stop(); return; } try{ const stream=canvas.captureStream(60); const at=merger.stream.getAudioTracks(); if(at.length) stream.addTrack(at[0]); let mt='video/webm;codecs=vp9,opus'; if(!MediaRecorder.isTypeSupported(mt)) mt='video/webm;codecs=vp8,opus'; if(!MediaRecorder.isTypeSupported(mt)) mt='video/webm'; mr=new MediaRecorder(stream,{mimeType:mt}); chunks=[]; mr.ondataavailable=e=>{ if(e.data.size) chunks.push(e.data); }; mr.onstop=()=>{ const blob=new Blob(chunks,{type:'video/webm'}); const url=URL.createObjectURL(blob); dl.href=url; dl.style.display='inline'; dl.textContent='Download'; dl.download=`psy_kaleido_${Date.now()}.webm`; recBtn.textContent='‚è∫ Start'; }; mr.start(); recBtn.textContent='‚èπ Stop'; dl.style.display='none'; }catch(err){ alert('Recording not supported here: '+err.message+'\\nTip: desktop Chrome gives audio+video.'); } };

  /* ========= Touch gestures (linked to audio) ========= */
  const touchLinkSel=document.getElementById('touchAudio');
  let pointers=new Map(), lastDist=0, lastTap=0;
  let spinDrag=0, zoomDrag=0;
  canvas.addEventListener('pointerdown',e=>{ pointers.set(e.pointerId,e); canvas.setPointerCapture?.(e.pointerId); const t=performance.now(); if(t-lastTap<350){ panel.classList.toggle('hidden'); } lastTap=t; });
  canvas.addEventListener('pointermove',e=>{ if(!pointers.has(e.pointerId)) return; const prev=pointers.get(e.pointerId); pointers.set(e.pointerId,e);
    if(pointers.size===1){ const dx=e.clientX-prev.clientX; spinDrag+=dx*0.002;
      if(touchLinkSel.value==='1' && audio && audio.playbackRate!==undefined && !audio.paused){ audio.playbackRate=Math.max(0.25,Math.min(2.0,1+dx*0.002+scratch*0.2)); } }
    else if(pointers.size===2){ const [a,b]=[...pointers.values()]; const d=Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY); if(!lastDist) lastDist=d; const dd=d-lastDist; lastDist=d; zoomDrag+=dd*0.003;
      if(touchLinkSel.value==='1'){ const f=Math.max(80,Math.min(12000, 900*(zoomBase+zoomDrag))); filter.frequency.setTargetAtTime(f, actx.currentTime, 0.02); } } });
  function endPtr(e){ pointers.delete(e.pointerId); if(pointers.size<2) lastDist=0; }
  canvas.addEventListener('pointerup',endPtr); canvas.addEventListener('pointercancel',endPtr); canvas.addEventListener('pointerleave',endPtr);

  /* ========= Panel fields / display ========= */
  wedges.oninput=()=>wedgesV.textContent=wedges.value;

  /* ========= FPS + Render loop ========= */
  const fpsEl=document.getElementById('fps'); let lastF=performance.now(), frames=0;
  let t0=performance.now(); let rot=0;
  function loop(){ requestAnimationFrame(loop); const now=performance.now(); const dt=(now-t0)/1000; t0=now; frames++; if(now-lastF>500){ fpsEl.textContent=(frames*1000/(now-lastF)).toFixed(0); lastF=now; frames=0; }
    // update video texture
    if(video && video.readyState>=2){ gl.bindTexture(gl.TEXTURE_2D,TEX); gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true); gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,video); }
    // spin from wheels + drag
    rot += (spinWheel + spinDrag) * dt; spinDrag *= 0.96;
    const zoom = Math.max(0.2, Math.min(4, zoomBase + zoomDrag)); zoomDrag *= 0.9;
    // ease audio playbackRate back to 1
    if(pointers.size===0 && audio && !audio.paused && Math.abs(audio.playbackRate-1)>0.001){ audio.playbackRate += (1 - audio.playbackRate) * 0.06; }
    gl.useProgram(P);
    gl.uniform2f(uR,canvas.width,canvas.height);
    gl.uniform1f(uT,now/1000);
    gl.uniform1i(uK,Math.max(2,parseInt(wedges.value,10)));
    gl.uniform1f(uROT,rot + scratch*0.2);
    gl.uniform1f(uZOOM,zoom);
    gl.uniform1f(uTW,twist);
    gl.uniform1i(uMIR, mirror.value==='1'?1:0);
    gl.uniform1i(uHAS,HAS?1:0);
    gl.drawArrays(gl.TRIANGLE_STRIP,0,4);
  }
  loop();
})();document.getElementById('donate').onclick = () => {
  // Replace with your actual Cash App link / tag
  window.open("https://cash.app/$lightwell333", "_blank");
};

</script>
</body>
</html>

